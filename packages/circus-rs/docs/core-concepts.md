---
title: Core Concepts of CIRCUS RS
---

# CIRCUS RS クライアントの基本構成

CIRCUS RS のクライアントの動作を理解するために、以下の**クラス**の働きの理解が最低限必要です。ここで言うクラスとは、 ES2015 (ES6) の `class` 構文で作られるものと等価です。

CIRCUS RS で表示されるすべての画像およびアノテーションは高度に抽象化されています。

## Viewer --- ビューアコンポーネント本体

Viewer は HTML 上に描画されるビューアコンポーネント本体であり、CIRCUS RSの基本クラスです。 Viewer は1つの HTML Canvas を保持し、 ImageSource および Annotation （あれば）をウェブ画面上にレンダリングします。 ImageSource および Annottation は Composition という名前のコンテナクラス上に保管されます。

Viewer に割り当てることのできる Composition は1つだけです。一方で、Composition は2つ以上の Viewer に同時に割り当てることができます。つまり、1つの画像ソースを複数のビューアに同時に割り当てて、違う描画設定で観察できます。例えば1つのボリュームをMPRで複数の方向から観察することが可能です。

## ViewState --- 画像の各種描画設定

ViewState は ImageSource がどのような条件で画面上に表示されるかのデータを保持するオブジェクトです（クラスではありません）。例えば、ウィンドウ幅やウィンドウレベルを変えることで画像の見た目は変化するので、これらウィンドウの設定は代表的な ViewState の属性です。

ImageSource と ViewState を組み合わせることで、画面に描画されるべき1つの画像が決定されます。

現時点で実装されている ViewState は3次元ボリューム画像を前提としたプロパティのみ定義されています。
{:.alert .alert-info}

## ImageSource --- 表示される画像そのもの

ImageSource は表示される画像そのものを表す抽象クラスであり、 ViewState を受け取って実際のキャンバスへの画像の描画を行います。1つのImageSource は（Composition を経由して）複数の Viewer に同時に割り当てることができます。

現時点で実装されているImageSourceはすべて3次元ボリューム画像を対象としています。
{:.alert .alert-info}

画像へのアクセス方法別に、複数の実装が存在します。

`DynamicImageSource`
: 描画の都度、サーバーからボリュームのMPR画像を取得して描画します。メモリやCPUリソースに限りがあるデバイス上での選択肢です。

`RawVolumeImageSource`
: はじめにサーバーからボリュームデータ全体を取得した後、クライアント側でMPRデータを生成して描画します。ボリューム全体を最初にダウンロードするために初期のレスポンス時間は遅くなりますが、マシンが十分に高速であれば最もスムースな描画が期待できます。

`HybridImageSource`
: 基本的な動きは `RawVolumeImageSource` と同じですが、ボリュームを取得し終えるまでの間は `DynamicImageSource` としても動作します。これにより最初の画像表示までのタイムラグを抑えられる一方で、ロード完了後にはローカルマシンでのMRP計算による高速な描画が行えます。

## Annotation --- 画像に付随する注記データ

詳細は [Working with Annotations](annotation.html) を参照。
{:.tip}

Annotation は、画像に付随する各種注記（アノテーション）を表現するベースクラスです。アノテーションとは、例えば以下のようなものです。

- 病変をマークする矢印
- 病変を計測するためのルーラー
- 3Dボリュームラベル (VoxelCloud)

アノテーションは Viewer に直接割り当てるのではなく、 Composition に割りあてて、 Composition を Viewer に割り当てることで使用します。

1つの Composition には任意の数のアノテーションを登録することが可能です。

## Composition --- ImageSource と Annotation のコレクション

Viewer に表示される画像と、それに付随する Annotation とをまとめるためのコンテナクラスです。

- 1つのComposition には1つのみの ImageSource が割り当てられます。
- 1つのComposition には 複数の（正確には0個以上の） Annotation を割り当てることができます。
- 1つのCompositionは複数の Viewer に同時に割り当てることができます。つまり、複数のビューアを使って1つの画像を様々な描画設定（角度・ウィンドウなど）で観察することが可能です。

## Tool --- ビューア上のUIイベントを処理するツール

詳細は [Working with Tools](tool.html) を参照。
{:.tip}

Viewer 上で発生するマウス・キーボードイベントに対応して何らかの動作を行うツールの抽象基底クラスです。デフォルトでアクティブになっているツールは 「空ツール」であり、ビューア上のマウス・キーボードイベントに一切反応しません（つまり、 `<img>` タグと同様に静的に画像を表示するだけになります）。

CIRCUS RSには複数のツールがデフォルトで用意されており、これらは Viewer の `setTool` メソッドで切り替えることができます。自分で独自のツールを実装することも可能です。

アクティブなツールは Viewer 毎に独立して設定されます。つまり、同じ ImageSource を表示していても、ある Viewer ではページングツールが、ある Viewer ではウィンドウツールがアクティブ、という状況を意図的に作り出すことが可能です。ただし大抵の場合は共通のツールを使いたいでしょうから、UIのプログラムでそのように実装するようにしてください。

マウスイベント等に反応してアクティブなツールが行うことは、主に「Viewer の描画設定の変更」「Annotation の作成・編集」の2つです。前者はウィンドウの変更やページングが該当し、後者は矢印アノテーションやボリュームアノテーションの作成などが該当します。

### ツールバーについて

CIRCUS RSの動作にツールバーは必須ではありませんが、簡易的なツールバーとアイコンが提供されています。詳細はツールについての説明を参照してください。
